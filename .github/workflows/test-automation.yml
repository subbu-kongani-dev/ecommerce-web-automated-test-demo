name: E-Commerce Test Automation CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to run tests on'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      os:
        description: 'Operating system to run tests on'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - windows-latest
          - macos-latest
      headless:
        description: 'Run in headless mode'
        required: true
        default: 'true'
        type: boolean

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    name: Run Automated Tests
    runs-on: ${{ matrix.os }}

    env:
      LT_USERNAME: ${{ secrets.LT_USERNAME }}
      LT_ACCESS_KEY: ${{ secrets.LT_ACCESS_KEY }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        browser: [chrome, firefox]
        java: [17]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: maven
      
      - name: Install Chrome Browser
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: Install Firefox Browser
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@latest
        with:
          firefox-version: latest
      
      - name: Verify Maven Installation
        run: mvn -version
      
      - name: Clean and Compile
        run: mvn clean compile
      
      - name: Run Tests
        run: mvn test -Dbrowser=${{ matrix.browser }} -Dheadless=true
        continue-on-error: true
      
      - name: Generate Test Report Summary
        if: always()
        run: |
          echo "Test execution completed"
          echo "## Test Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "reports" ]; then
            echo "âœ… **Test Reports:** $(ls -1 reports/ | wc -l) file(s)" >> $GITHUB_STEP_SUMMARY
            ls -la reports/
          else
            echo "âš ï¸ **Test Reports:** Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "screenshots" ]; then
            echo "ðŸ“¸ **Screenshots:** $(ls -1 screenshots/ | wc -l) file(s)" >> $GITHUB_STEP_SUMMARY
            ls -la screenshots/
          else
            echo "âš ï¸ **Screenshots:** Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "logs" ]; then
            echo "ðŸ“‹ **Log Files:** $(ls -1 logs/ | wc -l) file(s)" >> $GITHUB_STEP_SUMMARY
            ls -la logs/
          else
            echo "âš ï¸ **Log Files:** Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "test-output" ]; then
            echo "ðŸ“Š **TestNG Output:** Available" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}-${{ matrix.os }}-${{ github.run_number }}
          path: screenshots/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.browser }}-${{ matrix.os }}-${{ github.run_number }}
          path: logs/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.browser }}-${{ matrix.os }}-${{ github.run_number }}
          path: reports/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload TestNG Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-results-${{ matrix.browser }}-${{ matrix.os }}-${{ github.run_number }}
          path: |
            test-output/
            target/surefire-reports/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results (${{ matrix.browser }} on ${{ matrix.os }})
          path: 'target/surefire-reports/TEST-*.xml'
          reporter: java-junit
          fail-on-error: false
      
      - name: Upload Screenshots on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots-${{ matrix.browser }}-${{ matrix.os }}
          path: screenshots/
          retention-days: 30

  test-on-demand:
    name: Run Tests on ${{ github.event.inputs.os }}
    runs-on: ${{ github.event.inputs.os }}
    if: github.event_name == 'workflow_dispatch'

    env:
      LT_USERNAME: ${{ secrets.LT_USERNAME }}
      LT_ACCESS_KEY: ${{ secrets.LT_ACCESS_KEY }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Install Chrome Browser
        if: github.event.inputs.browser == 'chrome' && github.event.inputs.os == 'ubuntu-latest'
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: Install Firefox Browser
        if: github.event.inputs.browser == 'firefox' && github.event.inputs.os == 'ubuntu-latest'
        uses: browser-actions/setup-firefox@latest
        with:
          firefox-version: latest
      
      - name: Run Tests
        run: mvn test -Dbrowser=${{ github.event.inputs.browser }} -Dheadless=${{ github.event.inputs.headless }} -Dos.name=${{ github.event.inputs.os }}
        continue-on-error: true
      
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.event.inputs.browser }}-${{ github.event.inputs.os }}
          path: |
            reports/
            screenshots/
            logs/
          retention-days: 30

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Compile Code
        run: mvn clean compile
      
      - name: Run Maven Verify
        run: mvn verify -DskipTests

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [test, code-quality]
    if: always()
    
    steps:
      - name: Check Build Status
        run: |
          echo "Build completed!"
          echo "Test Job Status: ${{ needs.test.result }}"
          echo "Code Quality Job Status: ${{ needs.code-quality.result }}"
